---
title: "Mission: Iconic Reef"
author: "[Jeremiah Blondeau](https://github.com/jeremiaheb) + Rob Harper"
date: "`r format(Sys.time(), '%d %B %Y')`"
mail: "jeremiah.blondeau@noaa.gov"
github: "jeremiahheb/MissionIconicReef"
bibliography: references.bib
format: 
  html:
    page-layout: full
    toc: true
    number-sections: true
    fig-cap-location: bottom
    theme: lumen
    title-block: true
    title-block-banner: true
    tabset: true
    include-before-body: _logo.html 
  pdf:
    mainfont: ArialMT
    toc: true
    number-sections: true
    fig-cap-location: bottom
    fig-align: "center"
    include-in-header:
      text: |
        \usepackage{graphicx}
        \usepackage{titling}
        \pretitle{%
          \begin{center}
          \includegraphics[width=4cm]{noaa_logo.png}\\[1em]
          \LARGE
        }
        \posttitle{%
          \par\end{center}\vskip 1em
          \includegraphics[width=\textwidth]{MIRmap.png}
        }
---

<!-- html-only -->

```{=html}
<style>
  nav#TOC {
    font-size: 0.85em;
  }
</style>
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
# Needed Libraries
library(rvc)
library(tidyverse)
library(DT)
library(patchwork)
library(glue)

# Source Plotting Functions
source('code/labeler.R', local = knitr::knit_global())
source('code/QL_binned_LengthFreq.R', local = knitr::knit_global())
source('code/theme_publication.R', local = knitr::knit_global())
source('code/WrapperFunctions.R', local = knitr::knit_global())
source('code/MIR_Plot_functions.R', local = knitr::knit_global())

# Read in MIR data set
MIR_data <- readRDS("../data/MIR_Dataset.rds")

# Read in additional species size data (used to generate LF plots)
# This never changes! It is a list of all species codes + max size

community_data <- readRDS("../data/community_data.rds")


```

## Introduction

```{=html}
<script src="code/expand.js"></script>
```
<details class="expand" open>
<summary style="font-size:1.1em; font-weight:bold; cursor:pointer;">

</summary>
<br>

fish fish fish

count fish

big fish little fish

test

</details>

```{r, echo=FALSE, results='asis'}
# Map format to appear correct in HTML and PDF output
if (knitr::is_html_output()) {
  cat('<img src="MIRmap.png" alt="Map of M:IR Sites" width="100%" style="margin-top: 1em;">')
}
```




\newpage

## The Data

NCRMP fish surveys use the Reef Visual Census (RVC), stationary-point-count method modified from Bohnsack and Bannerot [@Bohnsack86]. Non-extractive visual surveys are conducted on shallow (\<30 m), hard-bottom coral reef habitats. A stratified-random, one-stage survey design was used to select and sample within 50 m x 50 m grid cells [@smith2011]. This dataset includes reef fish data collected from sample locations in the Florida Keys. For parity, the larger NCRMP dataset is restricted to strata types (i.e., depth and rugosity combinations) that occur within the M:IR areas (table 1).

### Strata

```{r echo=FALSE}
table <-  MIR_data$sample_data %>%
            group_by(PROT, STRAT) %>%
            summarise(n = length(unique(PRIMARY_SAMPLE_UNIT))) %>%
            mutate(description = case_when(
              STRAT == "FK01" ~ "inshore reefs, all depths",
              STRAT == "FK02" ~ "mid-channel patch reefs, all depths",
              STRAT == "FK03" ~ "offshore patch, all depths",
              STRAT == "FK04" ~ "forereef, low rugosity, <12m",
              STRAT == "FK05" ~ "forereef, high rugosity, <12m"
            )) %>%
            mutate(PROT = case_when(
              PROT == 0 ~ "Outside",
              PROT == 1 ~ "Inside"
            )) %>% 
            select(PROT, STRAT, description, n) %>%
            ungroup()
#conditional statement for rendering in both HTML and PDF
if (knitr::is_html_output()) {
  DT::datatable(table,
    class = "cell-border stripe", 
    rownames = FALSE,
    colnames = c("Study Area", "Strata Name", "Strata Description", "Sample Number"),
    caption = "Table 1. Number of sites sampled.",
    options = list(
      columnDefs = list(list(className = 'dt-center', targets = "_all")),
      info = FALSE,
      paging = FALSE,
      searching = FALSE
    )
  )
} else {
  knitr::kable(table,
               caption = "Table 1. Number of sites sampled.",
               col.names = c("Study Area", "Strata Name", "Strata Description", "Sample Number"),
               booktabs = TRUE) %>%
    kableExtra::kable_styling(latex_options = c("striped", "hold_position"), font_size = 10)
}

```

### Fish Species

Six reef fish species were chosen to represent different trophic levels and functional roles.

```{r echo=FALSE}
# To add species to the document, add species code here
target_species <- c(
  "HAE FLAV", "SPA VIRI", "SCA GUAC", "STE PLAN",
  "CAL CALA", "CAL NODO", "EPI MORI", "EPI ITAJ"
)

# Build spp_list dynamically from MIR_data$taxonomic_data
spp_list <- MIR_data$taxonomic_data %>%
  filter(SPECIES_CD %in% target_species) %>%
  select(SPECIES_CD, COMNAME, SCINAME) %>%
  distinct() %>%
  arrange(match(SPECIES_CD, target_species)) %>%
  left_join(community_data)   # preserve order



# Conditional rendering for HTML or PDF
if (knitr::is_html_output()) {
  DT::datatable(
    spp_list %>%
      mutate(COMNAME = sub("^([a-z])", "\\U\\1", COMNAME, perl = TRUE)),
    class = "cell-border stripe",
    rownames = FALSE,
    colnames = c("Species Code", "Common Name", "Scientific Name"),
    caption = "Table 2. Fish species. For analysis, both porgy species were combined.",
    options = list(
      columnDefs = list(list(className = 'dt-center', targets = "_all")),
      info = FALSE,
      paging = FALSE,
      searching = FALSE
    )
  ) %>%
    DT::formatStyle(columns = "SCINAME", fontStyle = "italic")
} else {
  knitr::kable(
    spp_list %>%
      mutate(COMNAME = sub("^([a-z])", "\\U\\1", COMNAME, perl = TRUE)),
    caption = "Table 2. Fish species. For analysis, both porgy species were combined.",
    col.names = c("Species Code", "Common Name", "Scientific Name"),
    booktabs = TRUE
  ) %>%
    kableExtra::kable_styling(latex_options = c("striped", "hold_position"), font_size = 10) %>%
    kableExtra::column_spec(3, italic = TRUE)
}

#joining target species with file that contains max size for LF plots

target_species_wmax <- spp_list %>%
  left_join(community_data, by = "SPECIES_CD")

```

\newpage

## Density

NCRMP’s comprehensive sampling design provides a broad, population-level perspective on the status and trends of the reef fish community. In particular, trend data can provide insight into how species respond to events including regional management actions such as targeted coral restoration efforts within the M:IR sites. Density results are shown as the number of individuals per survey area 177 m$^{2}$ ± SE.

```{r, fig.width=12, fig.height=8, echo=FALSE}
MIR_domain_dens_by_year(MIR_data, spp_list)
```

\newpage

## Occurrence

Occurrence measures how often a species is detected in surveys, providing insight into its distribution within M:IR sites and outside of M:IR sites in the Florida Keys. Results show presence regardless of abundance, helping to identify widespread versus rare species. Survey occurrence results are shown within M:IR sites (inside) and in the Florida Keys (outside) ± SE.

```{r, fig.width=12, fig.height=8, echo=FALSE}
MIR_domain_occ_by_year(MIR_data, spp_list)
```

\newpage

## Length Frequency

Length compositions provide a detailed description of a selected fish’s population structure. These highly informative figures can show the length at which a fish species recruits to the coral reef (i.e., young of year or from nursery habitat), length classes removed by the local fisheries, and the effectiveness of management actions


::: {.panel-tabset}

```{r, echo=FALSE, results='asis', fig.width=12, fig.height=10}
library(purrr)

walk2(spp_list$SPECIES_CD, spp_list$COMNAME, function(code, name) {
  cat("### ", name, "\n\n")   # Section header per species
  
  p <- render_LF_for_species(
    df = MIR_data,
    SPECIES_CD = code,
    COMNAME = name,
    yrs = c(2022, 2024)   # no bin_size here
  )
  
  print(p)
  cat("\n\n")
})
```


