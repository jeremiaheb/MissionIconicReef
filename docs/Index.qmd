---
title: "Mission: Iconic Reefs RVC Analysis"
author: "[Jeremiah Blondeau](https://github.com/jeremiaheb) + Rob Harper"
date: "`r format(Sys.time(), '%d %B %Y')`"
mail: "jeremiah.blondeau@noaa.gov"
github: "jeremiahheb/MissionIconicReef"
bibliography: references.bib
format: 
  html:
    page-layout: full
    toc: true
    number-sections: true
    fig-cap-location: bottom
    theme: lumen
    title-block: true
    title-block-banner: true
    tabset: true
    include-before-body: _logo.html 
  pdf:
    mainfont: ArialMT
    toc: true
    number-sections: true
    fig-cap-location: bottom
    fig-align: "center"
    include-in-header:
      text: |
        \usepackage{graphicx}
        \usepackage{titling}
        \pretitle{%
        \begin{center}
        \includegraphics[width=4cm]{MIR.png}\hspace{1em}%
        \includegraphics[width=4cm]{noaa_logo.png}\\[1em]
        \LARGE
        }
      
---
<!-- html-only -->

```{=html}
<style>
  nav#TOC {
    font-size: 0.85em;
  }
</style>

```



```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
# Needed Libraries
library(rvc)
library(tidyverse)
library(DT)
library(patchwork)
library(glue)


# Source Plotting Functions
source('code/labeler.R', local = knitr::knit_global())
source('code/QL_binned_LengthFreq.R', local = knitr::knit_global())
source('code/theme_publication.R', local = knitr::knit_global())
source('code/WrapperFunctions.R', local = knitr::knit_global())
source('code/MIR_Plot_functions.R', local = knitr::knit_global())

# Read in MIR data set
MIR_data <- readRDS("../data/MIR_Dataset.rds")

# Read in additional species size data (used to generate LF plots)
# This never changes! It is a list of all species codes + max size

community_data <- readRDS("../data/community_data.rds")


```

## Introduction

```{=html}
<script src="code/expand.js"></script>
```
<details class="expand" open>
<summary style="font-size:1.1em; font-weight:bold; cursor:pointer;">

</summary>
<br>

[Mission: Iconic Reefs](https://missioniconicreefs.org/) is a multi-institutional initiative designed to restore ecological function and biodiversity across key reef sites in the Florida Keys. Led by NOAA’s Office of Habitat Conservation and the Florida Keys National Marine Sanctuary in collaboration with federal, state, institutional, and non-profit partners, M:IR targets nearly three million square feet of reef, employing a phased restoration strategy. The overarching goal is to restore coral cover and reef function to a self-sustaining state.

Monitoring the response of reef fish populations to these restoration interventions is critical for evaluating ecological outcomes [@Feeley2025]. The National Coral Reef Monitoring Program (NCRMP) conducts non-extractive Reef Visual Census (RVC) surveys using a stationary-point-count method modified from Bohnsack and Bannerot (1986) [@Bohnsack86; @Towle2025]. Surveys are conducted on shallow (<30 m), hard-bottom reef habitats and employ a stratified-random, one-stage design within 50 m × 50 m grid cells to ensure representative sampling across depth and rugosity strata [@Towle2025; @Ault2021]. For this analysis, the NCRMP dataset was restricted to strata types overlapping M:IR sites to allow direct comparisons of fish communities inside and outside restoration areas.

Six reef fish species were selected to represent a range of trophic levels and functional roles. NCRMP’s extensive sampling provides population-level insights into density (number of individuals per 177 m$^{2}$ ± SE), occurrence (frequency of detection within and outside M:IR sites ± SE), and relative length frequency distributions. Density and occurrence metrics enable detection of shifts in abundance and distribution patterns in response to environmental disturbances and management interventions [@Ault2021]. Length frequency data provide detailed information on population structure, recruitment, and potential fishing impacts, serving as an indicator of restoration effectiveness and long-term population sustainability [@Ault2021].  Analysis was completed using the Blondeau & Ganz RVC Statistics package in R [@Ganz2015].


</details>
### Map of M:IR Sites
```{r, echo=FALSE, results='asis', out.width='80%', fig.align='center'}
if (knitr::is_html_output()) {
  cat('<img src="MIRmap.png" alt="Map of M:IR Sites" width="100%" style="margin-top: 1em;">')
} else {
  knitr::include_graphics("MIRmap.png")
}
```


\newpage

## The Data

NCRMP fish surveys use the Reef Visual Census (RVC), stationary-point-count method modified from Bohnsack and Bannerot [@Bohnsack86; Feeley2025]. Non-extractive visual surveys are conducted on shallow (\<30 m), hard-bottom coral reef habitats. A stratified-random, one-stage survey design was used to select and sample within 50 m x 50 m grid cells [@Ault2021]. This dataset includes reef fish data collected from sample locations in the Florida Keys. For parity, the larger NCRMP dataset is restricted to strata types (i.e., depth and rugosity combinations) that occur within the M:IR areas (table 1).

### Strata

```{r echo=FALSE}
render_strata_table(MIR_data$sample_data, caption = "Number of sites sampled by year.")
```

\newpage

### Fish Species

Six reef fish species were chosen to represent different trophic levels and functional roles.

``` {r echo=FALSE}
# To add species to the document, add species code here
target_species <- c(
  "HAE FLAV", "SPA VIRI", "SCA GUAC", "STE PLAN",
  "CAL CALA", "CAL NODO", "EPI MORI", 
  "EPI ITAJ",
  "THA BIFA", "HAL GARN", "STE LEUC", "SPA AURO",
  "ABU SAXA", "HAE SCIU", "OCY CHRY", "LUT GRIS"
)

# Build spp_list dynamically with image paths for later use in tables/plots

spp_list <- MIR_data$taxonomic_data %>%
  filter(SPECIES_CD %in% target_species) %>%
  select(SPECIES_CD, COMNAME, SCINAME) %>%
  distinct() %>%
  arrange(match(SPECIES_CD, target_species)) %>%
  left_join(community_data) %>%
  mutate(
    COMNAME = stringr::str_to_title(COMNAME),
    img_path = file.path("species_photos", paste0(gsub(" ", "_", SPECIES_CD), ".png"))
  )

render_species_table(spp_list, caption = "Fish species with representative photos. For analysis, both porgy species were combined.")
```


```{r, echo = FALSE}
#Merging species for analysis. Repeat chunk for merging other species 
MIR_data_merged <- MIR_data
MIR_data_merged$sample_data <- MIR_data$sample_data %>%
  mutate(SPECIES_CD = ifelse(SPECIES_CD %in% c("CAL CALA", "CAL NODO"), "CAL CALA", SPECIES_CD))

#creating spp_list_merged for plots with merged species data. 
#spp_list is still used in table to show original species information
spp_list_merged <- spp_list %>%
  mutate(
    COMNAME = ifelse(SPECIES_CD %in% c("CAL CALA", "CAL NODO"), "Porgy", COMNAME),
    SPECIES_CD = ifelse(SPECIES_CD %in% c("CAL CALA", "CAL NODO"), "CAL CALA", SPECIES_CD),
    SCINAME = ifelse(SPECIES_CD == "CAL CALA", "Calamus spp.", SCINAME) 
  ) %>%
  distinct(SPECIES_CD, COMNAME, SCINAME, .keep_all = TRUE)
  
```

\newpage

## Density

NCRMP’s comprehensive sampling design provides a broad, population-level perspective on the status and trends of the reef fish community. In particular, trend data can provide insight into how species respond to events including regional management actions such as targeted coral restoration efforts within the M:IR sites. Density results are shown as the number of individuals per survey area 177 m$^{2}$ ± SE.

```{r, fig.width=12, fig.height=8, echo=FALSE}
MIR_domain_dens_by_year(MIR_data_merged, spp_list_merged)
```

\newpage

## Occurrence

Occurrence measures how often a species is detected in surveys, providing insight into its distribution within M:IR sites and outside of M:IR sites in the Florida Keys. Results show presence regardless of abundance, helping to identify widespread versus rare species. Survey occurrence results are shown within M:IR sites (inside) and in the Florida Keys (outside) ± SE.

```{r, fig.width=12, fig.height=8, echo=FALSE}
MIR_domain_occ_by_year(MIR_data_merged, spp_list_merged)
```

\newpage

## Length Frequency

Length compositions provide a detailed description of a selected fish’s population structure. These highly informative figures can show the length at which a fish species recruits to the coral reef (i.e., young of year or from nursery habitat), length classes removed by the local fisheries, and the effectiveness of management actions


::: {.panel-tabset}

```{r, echo=FALSE, results='asis', fig.width=12, fig.height=10}
#Length frequency plots
pwalk(
  spp_list_merged,
  function(SPECIES_CD, COMNAME, SCINAME, max_size, ...) {
    cat("### ", COMNAME, "\n\n")
    p <- render_LF_plots(
      df         = MIR_data_merged,   
      SPECIES_CD = SPECIES_CD,
      COMNAME    = COMNAME,
      max_size   = max_size,
      yrs        = c(2022, 2024),
      target_bins = 10
    )
    print(p)
    cat("\n\n")
  }
)
```

\newpage
## References


