---
title: "Mission: Iconic Reef"
author: "[Jeremiah Blondeau](https://github.com/jeremiaheb) + Rob Harper"
date: "`r format(Sys.time(), '%d %B %Y')`"
mail: "jeremiah.blondeau@noaa.gov"
github: "jeremiahheb/MissionIconicReef"
bibliography: references.bib
format: 
  html:
    toc: true
    number-sections: true
    fig-cap-location: bottom
    theme: lumen
    title-block: true
    title-block-banner: true
    logo: noaa_logo.png
    tabset: true 
  pdf:
    toc: true
    number-sections: true
    fig-cap-location: bottom
    fig-align: "center"
    include-in-header:
      text: |
        \usepackage{graphicx}
        \usepackage{titling}
        \pretitle{%
          \begin{center}
          \includegraphics[width=4cm]{noaa_logo.png}\\[1em]
          \LARGE
        }
        \posttitle{%
          \par\end{center}\vskip 1em
          \includegraphics[width=\textwidth]{MIRmap.png}
        }
---

<!-- html-only -->

```{=html}
<style>
  nav#TOC {
    font-size: 0.85em;
  }
</style>
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
# Needed Libraries
library(rvc)
library(tidyverse)
library(DT)

# Source Plotting Functions
source('code/labeler.R', local = knitr::knit_global())
source('code/QL_binned_LengthFreq.R', local = knitr::knit_global())
source('code/theme_publication.R', local = knitr::knit_global())
source('code/WrapperFunctions.R', local = knitr::knit_global())
source('code/MIR_Plot_functions.R', local = knitr::knit_global())

# Read in MIR data set
MIR_data <- readRDS("../data/MIR_Dataset.rds")
```

```{r, echo=FALSE, results='asis'}
# Map format to appear correct in HTML and PDF output
if (knitr::is_html_output()) {
  cat('<img src="MIRmap.png" alt="Map of M:IR Sites" width="100%" style="margin-top: 1em;">')
}
```

\newpage

## The Data

The RVC, stationary-point-count method is modified from Bohnsack and Bannerot [@Bohnsack86] and is conducted on shallow (\<100ft), hardbottom coral reef habitats. Field surveys use a one-stage design to sample 50 m x 50 m grid cells selected using a stratified-random sampling allocation. This data set represents sample locations in the Florida Keys. Only those strata types found within the MIR areas were considered (table 1).

```{r echo=FALSE}
table <-  MIR_data$sample_data %>%
            group_by(PROT, STRAT) %>%
            summarise(n = length(unique(PRIMARY_SAMPLE_UNIT))) %>%
            mutate(description = case_when(
              STRAT == "FK01" ~ "inshore reefs, all depths",
              STRAT == "FK02" ~ "mid-channel patch reefs, all depths",
              STRAT == "FK03" ~ "offshore patch, all depths",
              STRAT == "FK04" ~ "forereef, low rugosity, <12m",
              STRAT == "FK05" ~ "forereef, high rugosity, <12m"
            )) %>%
            mutate(PROT = case_when(
              PROT == 0 ~ "Outside",
              PROT == 1 ~ "Inside"
            )) %>% 
            select(PROT, STRAT, description, n) %>%
            ungroup()
#conditional statement for rendering in both HTML and PDF
if (knitr::is_html_output()) {
  DT::datatable(table,
    class = "cell-border stripe", 
    rownames = FALSE,
    colnames = c("Study Area", "Strata Name", "Strata Description", "Sample Number"),
    caption = "Table 1. Number of sites sampled.",
    options = list(
      columnDefs = list(list(className = 'dt-center', targets = "_all")),
      info = FALSE,
      paging = FALSE,
      searching = FALSE
    )
  )
} else {
  knitr::kable(table,
               caption = "Table 1. Number of sites sampled.",
               col.names = c("Study Area", "Strata Name", "Strata Description", "Sample Number"),
               booktabs = TRUE) %>%
    kableExtra::kable_styling(latex_options = c("striped", "hold_position"), font_size = 10)
}

```

## Fish Species

A selection of fish species were chosen to represent different trophic levels and functional roles.

```{r echo=FALSE}
spp_list <- tribble(
  ~SPECIES_CD, ~CommonName, ~SciName,
  "HAE FLAV", "French Grunt", "Haemulon flavolineatum",
  "SPA VIRI", "Stoplight Parrotfish", "Sparisoma viride",
  "SCA GUAC", "Rainbow Parrotfish", "Scarus guacamaia", 
  "STE PLAN", "3-Spot Damselfish", "Stegastes planifrons",
  "CAL CALA", "Porgy", "Calamus calamus",
  "CAL NODO", "Porgy", "Calamus nodosus",
  "EPI MORI", "Red Grouper", "Epinephelus morio"
) %>%
as.data.frame()

#conditional statement for rendering in both HTML and PDF
if (knitr::is_html_output()) {
  DT::datatable(spp_list,
    class = "cell-border stripe",
    rownames = FALSE,
    colnames = c("Species Code", "Common Name", "Scientific Name"),
    caption = "Table 2. Fish species. For analysis, both porgy species were combined.",
    options = list(
      columnDefs = list(list(className = 'dt-center', targets = "_all")),
      info = FALSE,
      paging = FALSE,
      searching = FALSE
    )
  ) %>%
    DT::formatStyle(columns = "SciName", fontStyle = "italic")
} else {
  knitr::kable(spp_list,
               caption = "Table 2. Fish species. For analysis, both porgy species were combined.",
               col.names = c("Species Code", "Common Name", "Scientific Name"),
               booktabs = TRUE) %>%
    kableExtra::kable_styling(latex_options = c("striped", "hold_position"), font_size = 10) %>%
    kableExtra::column_spec(3, italic = TRUE)
}
```

\newpage

## Density

NCRMP’s comprehensive sampling design strategy provides a broad, population-level perspective on the reef fish community. NCRMP surveys capture a snapshot of these coral reef fish populations. Reporting temporal trends provides a comprehensive perspective of changes in reef fish populations. In particular, trend data can provide insight into how species respond to management actions including targeted restoration efforts within M:IR sites. Density is represented as the number of individuals per 177 m$^{2}$ ± SE.

```{r, fig.width=7, fig.height=5, echo=FALSE}
MIR_domain_dens_by_year(MIR_data, spp_list)
```

\newpage

## Occurrence

Occurrence measures how often a species is detected across surveyed sites, providing insight into its distribution within and outside M:IR areas. It reflects presence regardless of abundance, helping to identify widespread versus rare species. Survey occurrence is shown within MIR sites and outside ± SE.

```{r, fig.width=7, fig.height=5, echo=FALSE}
MIR_domain_occ_by_year(MIR_data, spp_list)
```

\newpage

## Length Frequency {.tabset}

Length compositions provide a detailed description of a selected fish’s population structure. These highly informative figures can show the length at which a fish species recruits to the coral reef from their nursery habitat, length classes that are selected by the local recreational and commercial fisheries, and the success of management practices. Relative length frequency are shown of species within MIR sites and outside

### French Grunt

```{r, fig.show="hold", out.width="50%", echo=FALSE}
MIR_LF(df = MIR_data, spp = "hae flav", bin_size = 5, yrs = 2022, spp_name = "French grunt")
MIR_LF(df = MIR_data, spp = "hae flav", bin_size = 5, yrs = 2024, spp_name = "French grunt")
```

### Stoplight Parrotfish

```{r, fig.show="hold", out.width="50%", echo=FALSE}
MIR_LF(df = MIR_data, spp = "spa viri", bin_size = 5, yrs = 2022, spp_name = "Stoplight parrotfish")
MIR_LF(df = MIR_data, spp = "spa viri", bin_size = 5, yrs = 2024, spp_name = "Stoplight parrotfish")
```

### Rainbow Parrotfish

```{r, fig.show="hold", out.width="50%", echo=FALSE}
MIR_LF(df = MIR_data, spp = "sca guac", bin_size = 5, yrs = 2022, spp_name = "Rainbow parrotfish")
MIR_LF(df = MIR_data, spp = "sca guac", bin_size = 5, yrs = 2024, spp_name = "Rainbow parrotfish")
```

### 3-Spot Damselfish

```{r, fig.show="hold", out.width="50%", echo=FALSE}
MIR_LF(df = MIR_data, spp = "ste plan", bin_size = 2, yrs = 2022, spp_name = "3-spot damselfish")
MIR_LF(df = MIR_data, spp = "ste plan", bin_size = 2, yrs = 2024, spp_name = "3-spot damselfish")
```

### Porgy

```{r, fig.show="hold", out.width="50%", echo=FALSE}
MIR_data_copy <- MIR_data
MIR_data_copy$sample_data <- MIR_data_copy$sample_data %>%
  mutate(SPECIES_CD = if_else(SPECIES_CD == "CAL CALA", "CAL NODO", SPECIES_CD))
#Merged CAL CALA and CAL NODO to graph both porgy species together
MIR_LF(df = MIR_data_copy, spp = "CAL NODO", bin_size = 4, yrs = 2022, spp_name = "Porgy")
MIR_LF(df = MIR_data_copy, spp = "CAL NODO", bin_size = 4, yrs = 2024, spp_name = "Porgy")
```

### Red Grouper

```{r, fig.show="hold", out.width="50%", echo=FALSE}
MIR_LF(df = MIR_data, spp = "epi mori", bin_size = 5, yrs = 2022, spp_name = "Red Grouper")
MIR_LF(df = MIR_data, spp = "epi mori", bin_size = 5, yrs = 2024, spp_name = "Red Grouper")
```
